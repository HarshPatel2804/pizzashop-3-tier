@{
    Layout = "_OrderAppLayout";
    ViewData["Title"] = "Table Page";
}
@using pizzashop.repository.ViewModels;
@using static pizzashop.repository.Models.itemtype;
@model List<CategoryViewModel>;

<head>
    <link rel="stylesheet" href="~/css/OrderMenu.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
        integrity="sha512-MX5EkfBl..." crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<section style="background-color: #fcfcfc;" class="row w-100">
    <aside class="col-auto d-flex justify-content-start align-items-center flex-column offcanvas-lg offcanvas-start"
        id=sidebar style="background-color: #f4f4f4 !important; min-width: 250px; min-height: 100vh;">
        <div class="w-100 mt-3 mb-3">
            <span class="fw-bold ms-4" style="font-size: 20px;">Category</span>
            <button type="button" class="btn-close text-reset ms-auto d-lg-none" data-bs-dismiss="offcanvas"
                data-bs-target="#sidebar" aria-label="Close"></button>
        </div>
        <a class='menu w-100' data-id="FAV">
            <span style="font-weight: 600;" class="text ms-4">Favorite Items</span>
        </a>
        <a class='menu w-100  Categoey-active' data-id="ALL">
            <span style="font-weight: 600;" class="text ms-4">All</span>
        </a>
        @foreach (var category in Model)
        {
            <a class="menu w-100" data-id="@category.Categoryid">
                <span style="font-weight: 600;" class="text ms-4">@category.Categoryname</span>
            </a>
        }

    </aside>
    <div class="d-flex flex-column flex-lg-row col">
        <section style="height:100%; max-height: 100%; flex: 1">
            <div class=" d-flex justify-content-between ms-3 mt-4">
                <div class="search-input-group">
                    <input type="text" class="form-control search-input" placeholder="Search">
                    <div class="search-icon">
                        <i class="fa-solid fa-magnifying-glass"></i>
                    </div>
                </div>
                <div class="food-type me-4">
                    <div class="type-option">
                        <div class="indicator vegetarian"></div>
                        <span>Vegetarian</span>
                    </div>
                    <div class="type-option">
                        <div class="indicator non-vegetarian"></div>
                        <span>Non-Vegetarian</span>
                    </div>
                    <div class="type-option">
                        <div class="indicator vegan"></div>
                        <span>Vegan</span>
                    </div>
                </div>
            </div>

            <div id="menu-items" class="d-flex flex-wrap ms-4 mt-4 MenuItems overflow-auto">

            </div>
        </section>
        <div id="order-card" class="d-none OrderCard me-3 rounded shadow p-3 mt-3"
            style="flex : 1; align-self: flex-start; height: auto;">

        </div>
    </div>
</section>
<div id="ItemModifierModal">

</div>

<script>
    var parentOrderItemsArray = [];

    function addOrderItemsFromPartial(itemsFromPartial) {
        if (itemsFromPartial && Array.isArray(itemsFromPartial)) {
            parentOrderItemsArray = itemsFromPartial;
        }
    }
    $(document).ready(function () {
        let currentCategory = "ALL";
        let confirmedSelections = [];
        let orderTaxes = [];
        let appliedTaxIds = [];
        let tempSelections = null;
        let searchText = "";
        let lastSubTotal = 0;
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        const orderId = getQueryParam("orderId");
        console.log(orderId);

        if (orderId) {
            $('#order-card').removeClass('d-none');

            //Get already stored taxes
            $.ajax({
                url: '/Orders/GetOrderTaxIds',
                method: 'GET',
                data: { orderId: orderId },
                dataType: 'json',
                success: function (data) {
                    appliedTaxIds = data.taxIds;
                    console.log(appliedTaxIds);
                }
            });

            $.ajax({
                url: '/OrderMenu/OrderCard',
                type: 'GET',
                data: { orderId: orderId },
                success: function (result) {
                    $('#order-card').html(result);
                    confirmedSelections = JSON.parse(JSON.stringify(parentOrderItemsArray));
                    console.log(confirmedSelections);
                    renderConfirmedSelections();
                },
                error: function () {
                    $('#order-card').html('<p class="text-danger">Failed to load order details.</p>');
                }
            });



        }

        function renderConfirmedSelections() {
            console.log(confirmedSelections);
            const $container = $('#selected-items-container');
            $container.empty();

            confirmedSelections.forEach((item, index) => {
                const $template = $('#item-template').clone();
                $template.removeAttr('id').removeClass('d-none');
                const accordionId = `collapse-${item.uniqueId}`;

                $template.attr('data-item-id', item.itemId);
                $template.attr('data-unique-id', item.uniqueId);
                $template.find('.item-name').text(item.itemName);

                $template.find('.accordion-button')
                    .attr('data-bs-target', `#${accordionId}`)
                    .attr('aria-controls', accordionId);

                $template.find('.accordion-collapse')
                    .attr('id', accordionId);

                const $modifierList = $template.find('ul');
                $modifierList.empty();

                let totalModifierPrice = 0;

                for (const groupId in item.groups) {
                    const group = item.groups[groupId];

                    for (const modifierId in group.selectedModifiers) {
                        const modifier = group.selectedModifiers[modifierId];

                        totalModifierPrice += parseFloat(modifier.rate);

                        $modifierList.append(`<li>${modifier.modifierName} ₹${modifier.rate}</li>`);
                    }
                }

                console.log(item.itemRate);

                $template.find('.item-quantity').text(item.quantity);

                const itemPrice = item.quantity * parseFloat(item.itemRate);
                const modifierPrice = item.quantity * totalModifierPrice;

                $template.find('.item-base-price').text(`₹${itemPrice.toFixed(2)}`);
                if ($modifierList.children().length !== 0) {
                    $template.find('.item-total-price').text(`₹${modifierPrice.toFixed(2)}`);
                }

                $container.append($template);
            });
            calculateAndRenderTotals();
            setupItemControlEvents();
        }

        function setupItemControlEvents() {
            $('#selected-items-container').on('click', '.item-quantity-increase', function (e) {
                e.stopImmediatePropagation();
                const $itemContainer = $(this).closest('[data-unique-id]');
                const index = $itemContainer.data('unique-id');
                const $quantitySpan = $(this).siblings('.item-quantity');

                const itemIndex = confirmedSelections.findIndex(i => i.uniqueId === index);
                if (itemIndex !== -1) {
                    confirmedSelections[itemIndex].quantity += 1;
                    renderConfirmedSelections();
                }
            });

            $('#selected-items-container').on('click', '.item-quantity-decrease', function (e) {
                e.stopImmediatePropagation();
                const $itemContainer = $(this).closest('[data-unique-id]');
                const index = $itemContainer.data('unique-id');
                const $quantitySpan = $(this).siblings('.item-quantity');
                const itemIndex = confirmedSelections.findIndex(i => i.uniqueId === index);
                if (itemIndex !== -1) {
                    confirmedSelections[itemIndex].quantity -= 1;

                    if (confirmedSelections[itemIndex].quantity <= 0) {
                        confirmedSelections.splice(itemIndex, 1);
                    }

                    renderConfirmedSelections();
                }
            });

            $('#selected-items-container').on('click', '.remove-item', function () {
                const $itemContainer = $(this).closest('[data-unique-id]');
                const index = $itemContainer.data('unique-id');

                removeConfirmedItem(index);

                $itemContainer.remove();
            });

            function removeConfirmedItem(index) {
                const Index = confirmedSelections.findIndex(item => item.uniqueId === index);
                if (Index !== -1) {
                    confirmedSelections.splice(Index, 1);
                    renderConfirmedSelections();
                }
            }

        }

        function calculateSubTotal() {
            let subTotal = 0;
            if (!confirmedSelections || !Array.isArray(confirmedSelections)) {
                return 0;
            }
            confirmedSelections.forEach(item => {
                let itemTotal = 0;
                const itemRate = parseFloat(item.itemRate) || 0;
                const quantity = parseInt(item.quantity, 10) || 0;
                if (quantity > 0) {
                    itemTotal += itemRate * quantity;
                    if (item.groups) {
                        Object.values(item.groups).forEach(group => {
                            if (group.selectedModifiers) {
                                Object.values(group.selectedModifiers).forEach(modifier => {
                                    const modRate = parseFloat(modifier.rate) || 0;
                                    itemTotal += modRate * quantity;
                                });
                            }
                        });
                    }
                }
                subTotal += itemTotal;
            });
            lastSubTotal = subTotal;
            return subTotal;
        }

        function fetchTaxes(callback) {
            $.ajax({
                url: '/Taxes/GetEnabledTaxes',
                type: 'GET',
                dataType: 'json',
                success: function (response) {
                    console.log(response);
                    if (response && response.success && response.allTaxes) {
                        callback(response.allTaxes);
                    } else {
                        console.error("Failed to fetch taxes or invalid response format:", response);
                        callback([]);
                    }
                }
            });
        }

        function renderTaxesAndCalculateTotal(taxes, subTotal) {
            orderTaxes = [];
            const $taxesContainer = $('#taxes-container');
            $taxesContainer.empty();
            let currentTotal = subTotal;
            let taxHtml = '';
            let otherTax = calculateOtherTax();
            currentTotal += otherTax;

            if (!Array.isArray(taxes)) {
                taxes = [];
            }

            taxes.forEach(tax => {
                const taxValue = parseFloat(tax.taxvalue) || 0;
                const taxName = tax.taxname || 'Unnamed Tax';
                const isPercentage = tax.taxTypeName && tax.taxTypeName.toLowerCase().includes('percentage');

                if (isPercentage) {
                    const taxAmount = subTotal * (taxValue / 100);
                    orderTaxes.push({
                        taxid: tax.taxid,
                        orderid: orderId,
                        taxvalue: taxAmount
                    });
                    currentTotal += taxAmount;
                    taxHtml += `
                <div class="d-flex justify-content-between fs-6 tax-row percentage-tax"
                     data-tax-id="${tax.taxid}"
                     data-tax-type="percentage"
                     data-tax-percentage="${taxValue}">
                    <div>${taxName} (${taxValue}%):</div>
                    <div class="tax-amount">${taxAmount.toFixed(2)}</div>
                </div>`;
                } else {
                    const isCheckedBefore = appliedTaxIds.includes(tax.taxid);
                    const isChecked = isCheckedBefore ? 'checked' : '';

                    taxHtml += `
                <div class="d-flex justify-content-between fs-6 tax-row fixed-tax"
                     data-tax-id="${tax.taxid}"
                     data-tax-type="fixed"
                     data-tax-amount="${taxValue}">
                    <div>
                        <input type="checkbox" class="fixed-tax-checkbox me-1"
                               id="tax-chk-${tax.taxid}"
                               value="${taxValue}"
                               data-tax-id="${tax.taxid}" ${isChecked}>
                        <label for="tax-chk-${tax.taxid}">${taxName}:</label>
                    </div>
                    <div class="tax-amount">${taxValue.toFixed(2)}</div>
                </div>`;
                }
            });

            taxHtml += `
                <div class="d-flex justify-content-between fs-6 tax-row item-specific-tax">
                    <div>Other Taxes:</div>
                    <div class="tax-amount">${otherTax.toFixed(2)}</div>
                </div>`;

            $taxesContainer.html(taxHtml);
            $('#subtotal-value').text(subTotal.toFixed(2));
            $('#total-value').text(currentTotal.toFixed(2));
            attachCheckboxListeners();

            $taxesContainer.find('.fixed-tax-checkbox:checked').each(function () {
                $(this).trigger('change');
            });
        }

        function recalculateTotal() {
            orderTaxes = [];
            let currentTotal = lastSubTotal;
            let otherTax = calculateOtherTax();
            currentTotal += otherTax;
            orderTaxes.push({
                taxid: 0,
                orderid: orderId,
                taxvalue: otherTax
            });

            $('#taxes-container .percentage-tax').each(function () {
                const $taxRow = $(this);
                const percentage = parseFloat($taxRow.data('tax-percentage')) || 0;
                const taxId = parseInt($taxRow.data('tax-id')) || 0;
                const taxAmount = lastSubTotal * (percentage / 100);

                currentTotal += taxAmount;

                orderTaxes.push({
                    taxid: taxId,
                    orderid: orderId,
                    taxvalue: taxAmount
                });
            });

            $('#taxes-container .fixed-tax-checkbox:checked').each(function () {
                const $checkbox = $(this);
                const taxValue = parseFloat($checkbox.val()) || 0;
                const taxId = parseInt($checkbox.data('tax-id')) || 0;

                currentTotal += taxValue;

                orderTaxes.push({
                    taxid: taxId,
                    orderid: orderId,
                    taxvalue: taxValue
                });
            });

            $('#total-value').text(currentTotal.toFixed(2));
        }

        function attachCheckboxListeners() {
            $('#taxes-container').off('change', '.fixed-tax-checkbox').on('change', '.fixed-tax-checkbox', function () {
                const $checkbox = $(this);
                const taxId = parseInt($checkbox.data('tax-id'));
                if ($checkbox.is(':checked')) {
                    if (!appliedTaxIds.includes(taxId)) {
                        appliedTaxIds.push(taxId);
                    }
                } else {
                    appliedTaxIds = appliedTaxIds.filter(id => id !== taxId);
                }
                recalculateTotal();
            });
        }

        function calculateAndRenderTotals() {
            const subTotal = calculateSubTotal();
            fetchTaxes(function (taxes) {
                renderTaxesAndCalculateTotal(taxes, subTotal);
                recalculateTotal();
            });
        }

        function calculateOtherTax() {
            let itemSpecificTaxTotal = 0;
            console.log(confirmedSelections);
            confirmedSelections.forEach(item => {
                if ((item.defaultTax == 'True' || item.defaultTax == true) && item.tax) {
                    const itemRate = parseFloat(item.itemRate) || 0;
                    const quantity = parseInt(item.quantity, 10) || 0;
                    const itemTaxPercent = parseFloat(item.tax) || 0;
                    console.log(itemTaxPercent);

                    if (itemRate > 0 && quantity > 0 && itemTaxPercent > 0) {
                        const itemSubTotal = itemRate * quantity;
                        const itemTaxAmount = itemSubTotal * (itemTaxPercent / 100);
                        itemSpecificTaxTotal += itemTaxAmount;
                    }
                }
            });

            return itemSpecificTaxTotal;
        }

        function loadMenuItems() {
            searchText = $('.search-input').val().trim();
            $.ajax({
                url: '/OrderMenu/GetMenuItems',
                type: 'GET',
                data: {
                    categoryId: currentCategory,
                    searchText: searchText
                },
                success: function (result) {
                    $('.MenuItems').html(result);
                    initializeMenuItems();
                },
                error: function (error) {
                    console.error('Error loading menu items:', error);
                }
            });
        }

        $('.menu').on('click', function () {
            const categoryId = $(this).data('id');
            currentCategory = categoryId;

            $('.menu').removeClass('Categoey-active');
            $(this).addClass('Categoey-active');

            loadMenuItems();
        });

        $('.search-input').on('input', function () {
            searchText = $(this).val().trim();
            loadMenuItems();
        });

        function initializeMenuItems() {

            $('.heart-btn').on('click', function (e) {
                e.stopPropagation();
                const itemId = $(this).data('itemid');
                const isFavorite = $(this).hasClass('favorite');
                console.log(isFavorite);

                $.ajax({
                    url: '/OrderMenu/ToggleFavorite',
                    type: 'POST',
                    data: {
                        itemId: itemId,
                        isFavorite: !isFavorite
                    },
                    success: function (result) {
                        loadMenuItems();
                    },
                    error: function (error) {
                        console.error('Error updating favorite status:', error);
                    }
                });
            });

            $('.ItemCard').on('click', function () {
                const itemId = $(this).data('itemid');
                const itemName = $(this).data('name');
                const itemType = $(this).data('type');
                const rate = $(this).data('rate');
                const isTax = $(this).data('istax');
                const Tax = $(this).data('tax');
                console.log(itemName + rate);
                let triangleClass = '';
                switch (itemType) {
                    case "Veg":

                        triangleClass = 'veg';
                        break;
                    case "Nonveg":
                        triangleClass = 'non-veg';
                        break;
                    case "Vegan":
                        triangleClass = 'vegan-corner';
                        break;
                }
                console.log(triangleClass);

                $.ajax({
                    url: '/OrderMenu/GetItemModifiers',
                    type: 'GET',
                    data: {
                        itemId: itemId
                    },
                    success: function (data) {
                        if (data == "0") {
                            //No ModifierGroups

                            const timestamp = new Date().getTime();

                            tempSelections = {
                                uniqueId: `${itemId}-${timestamp}`,
                                itemId: itemId,
                                itemName: itemName,
                                itemRate: rate,
                                quantity: 1,
                                defaultTax: isTax,
                                tax: Tax,
                                groups: {}
                            };

                            console.log(tempSelections);

                            updateConfirmedSelections();
                        }
                        else {
                            $('#ItemModifierModal').html(data);
                            $('.itemName').text(itemName);
                            $('.ItemId').val(itemId);
                            $('.Rate').val(rate);
                            $('.isTax').val(isTax);
                            $('.Tax').val(Tax);
                            $('.modifierType')
                                .removeClass('veg non-veg vegan-corner')
                                .addClass(triangleClass);
                            $('#ItemModifiers').modal('show');
                            handlemodifierPopUp();
                        }
                    }
                });

            });
        }

        loadMenuItems();

        function updateConfirmedSelections() {
            if (!tempSelections) return;

            const identicalItemIndex = confirmedSelections.findIndex(item => {
                if (item.itemId !== tempSelections.itemId) return false;

                const tempGroupIds = Object.keys(tempSelections.groups);
                const itemGroupIds = Object.keys(item.groups);

                if (tempGroupIds.length !== itemGroupIds.length) return false;

                for (const groupId of tempGroupIds) {
                    if (!item.groups[groupId]) return false;

                    const tempModifiers = tempSelections.groups[groupId].selectedModifiers;
                    const itemModifiers = item.groups[groupId].selectedModifiers;

                    const tempModifierIds = Object.keys(tempModifiers);
                    const itemModifierIds = Object.keys(itemModifiers);

                    if (tempModifierIds.length !== itemModifierIds.length) return false;

                    for (const modifierId of tempModifierIds) {
                        if (!itemModifiers[modifierId]) return false;
                    }
                }

                return true;
            });

            if (identicalItemIndex !== -1) {
                confirmedSelections[identicalItemIndex].quantity += tempSelections.quantity;
            } else {
                confirmedSelections.push(JSON.parse(JSON.stringify(tempSelections)));
            }

            tempSelections = null;

            renderConfirmedSelections();
        }

        function handlemodifierPopUp() {
            initializeArray();
            function initializeArray() {
                const itemId = $('.ItemId').val();
                const itemName = $('.itemName').text();
                const rate = $('.Rate').val();
                const isTax = $('.isTax').val();
                const Tax = $('.Tax').val();
                const timestamp = new Date().getTime();

                tempSelections = {
                    uniqueId: `${itemId}-${timestamp}`,
                    itemId: itemId,
                    itemName: itemName,
                    itemRate: rate,
                    quantity: 1,
                    defaultTax: isTax,
                    tax: Tax,
                    groups: {}
                };

                console.log(tempSelections);

                const existingItem = confirmedSelections.find(item => item.itemId === itemId);

                resetVisualSelections();

                if (existingItem) {
                    tempSelections.groups = JSON.parse(JSON.stringify(existingItem.groups));

                    restoreVisualSelections(tempSelections);
                }
            };

            $('.modifier-card-custom').on('click', function () {
                console.log("clicked");
                if (!tempSelections) return;


                const $card = $(this);
                const groupId = $card.data('group');
                const mappingId = $card.data('mapping');
                const modifierId = $card.data('id');
                const minRequired = parseInt($card.data('min'));
                const maxAllowed = parseInt($card.data('max'));
                const modifierName = $card.find('span:first').text();
                const modifierRate = $card.find('span.text-muted').text().replace('₹', '');

                if (!tempSelections.groups[groupId]) {
                    const groupName = $card.data('groupname');

                    tempSelections.groups[groupId] = {
                        groupId: groupId,
                        mappingId: mappingId,
                        groupName: groupName,
                        minRequired: minRequired,
                        maxAllowed: maxAllowed,
                        selectedModifiers: {}
                    };
                }

                if ($card.hasClass('active')) {
                    $card.removeClass('active');
                    $card.css('background-color', '');
                    delete tempSelections.groups[groupId].selectedModifiers[modifierId];

                    if (Object.keys(tempSelections.groups[groupId].selectedModifiers).length === 0) {
                    }
                } else {
                    const currentSelections = Object.keys(tempSelections.groups[groupId].selectedModifiers).length;
                    if (currentSelections >= maxAllowed) {
                        toastr.error(`You can select maximum ${maxAllowed} options from ${tempSelections.groups[groupId].groupName}`);
                        return;
                    }

                    $card.addClass('active');
                    $card.css({
                        'background-color': '#e6f2ff',
                        'opacity': '0.9'
                    });

                    tempSelections.groups[groupId].selectedModifiers[modifierId] = {
                        modifierId: modifierId,
                        modifierName: modifierName,
                        rate: modifierRate
                    };
                }
            });

            $('#modifiersForm').on('submit', function (e) {
                e.preventDefault();

                if (!tempSelections) return;

                let allGroups = {};
                $('.modifier-card-custom').each(function () {
                    const $card = $(this);
                    const groupId = $card.data('group');

                    if (!allGroups[groupId]) {
                        allGroups[groupId] = {
                            minRequired: parseInt($card.data('min')),
                            maxAllowed: parseInt($card.data('max')),
                            groupName: $card.data('groupname')
                        };
                    }
                });

                let isValid = true;

                for (const groupId in allGroups) {
                    const group = allGroups[groupId];

                    let selectedCount = 0;
                    if (tempSelections.groups[groupId] && tempSelections.groups[groupId].selectedModifiers) {
                        selectedCount = Object.keys(tempSelections.groups[groupId].selectedModifiers).length;
                    }

                    if (selectedCount < group.minRequired) {
                        toastr.error(`Please select at least ${group.minRequired} options from ${group.groupName}`);
                        isValid = false;
                    }
                }

                if (isValid) {
                    updateConfirmedSelections();
                    console.log("Confirmed selections:", confirmedSelections);
                    $('#ItemModifiers').modal('hide');
                }
            });

            $('#ItemModifiers .btn-danger').on('click', function () {
                tempSelections = null;
            });

            function resetVisualSelections() {
                $('.modifier-card-custom').removeClass('active').css({
                    'background-color': '',
                    'opacity': ''
                });
            }

            function restoreVisualSelections(selectionData) {
                if (!selectionData) return;

                for (const groupId in selectionData.groups) {
                    const group = selectionData.groups[groupId];

                    for (const modifierId in group.selectedModifiers) {
                        $(`.modifier-card-custom[data-group="${groupId}"][data-id="${modifierId}"]`).addClass('active').css({
                            'background-color': '#e6f2ff',
                            'opacity': '0.9'
                        });
                    }
                }
            }

            function openModifiersModal(itemId, itemName) {
                $('.ItemId').val(itemId);
                $('.itemName').text(itemName);

                $('#ItemModifiers').modal('show');
            }

            function getAllConfirmedSelections() {
                return confirmedSelections;
            }

            function removeConfirmedItem(itemId) {
                const index = confirmedSelections.findIndex(item => item.itemId === itemId);
                if (index !== -1) {
                    confirmedSelections.splice(index, 1);
                }
            }
        }


        $('#order-card').on('click', '#Save-Order-Btn', function () {

            const data = {
                OrderId: orderId,
                Items: confirmedSelections,
                Taxes: orderTaxes
            };

            $.ajax({
                url: '/Orders/SaveOrder',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),

                success: function (response) {
                    console.log('Save successful:', response);
                    alert(response.message || 'Order saved successfully!');
                }
            });
        });
    });
</script>