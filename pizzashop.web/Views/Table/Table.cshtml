@{
    Layout = "_Layout";
    ViewData["Title"] = "Table Page";
}

<head>
    <link rel="stylesheet" href="~/css/Menu.css">

</head>
<section style="min-height: 100vh;background-color: #fafafa;">
    <div class="row pt-4 ms-1 me-1" style="height: 70px;">
        <h2 class="col" style="color: rgb(101, 101, 224); font-family: Roboto; font-weight: 550">Sections/Tables
            </h1>
    </div>
    <div id="nav-home" class="mt-3 ms-2 me-2">
        <div class="row" style="min-height: 600px;">
            <div class="col-auto" style="background: linear-gradient(to right, white, rgb(225, 224, 224))">
                <div class="row px-3 mt-1">
                    <div class="col-auto d-flex align-items-center me-5 fw-bold" style="font-size: 20px;">Section
                    </div>
                    <button class="btn col-auto ms-5" type="button" data-bs-toggle="modal"
                        data-bs-target="#addSectionModal">
                        <img src="~/images/more.png" style="width: 30px;">
                    </button>
                </div>
                <div class="row overflow-auto me-2 mt-2" style="height: 400px;" id="Sections">

                </div>
            </div>
            <div class="col">
                <div class="row px-3 mt-1" style='height: 50px;'>
                    <div class="col-auto d-flex align-items-center  fw-bold" style="font-size: 20px;">Table
                    </div>
                    <input type="search" class="col-md-auto col-6 me-1 ms-auto " id="search" placeholder="search"
                        style="border-radius: 3px; border: 1px solid black">
                    <button type="button" class="btn" style="width: 50px; border: 1px solid black"><img
                            src="~/images/trash.svg"></button>
                    <button type="button" class="btn col-md-auto col-3 ms-1 align-items-center d-flex addTable"
                        style="border-radius: 2px; border: 1px solid black; background-color: rgb(85, 85, 247); color: white  !important;">
                        + New Table
                    </button>
                </div>

                <div class="row table-responsive pt-4 ms-2 me-2" id="TablesBySection">

                </div>
            </div>
        </div>
    </div>

    @* delete section modal *@
    <div class="fade modal" id="DeleteSectionModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" style="width: 400px;">
            <div class="modal-content">
                <div class="row mx-1 mt-2">
                    <h5 class="modal-title col" id="staticBackdropLabel">Delete confirmation</h5>
                    <button type="button" class="btn-close col-auto me-1" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="d-flex justify-content-center align-items-center mt-4 flex-column">
                    <img src="~/images/caution.png" style="height: 40px; width: 40px;">
                    <span>Are you sure you want to delete this section?</span>
                    <form id="deleteSectionForm">
                        <input id="hiddenField" type="hidden" />
                        <div class="d-flex justify-content-center align-items-center mt-2 mb-4">
                            <button type="submit" class="btn btn-primary" data-bs-dismiss="modal"
                                style="border-radius: 3px; width: 60px;">Yes</button>
                            <button type="button" class="btn ms-2 border"
                                style="border-radius: 3px; width: 60px;">No</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    @* delete table modal *@
    <div class="fade modal" id="DeleteTableModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" style="width: 400px;">
            <div class="modal-content">
                <div class="row mx-1 mt-2">
                    <h5 class="modal-title col" id="staticBackdropLabel">Delete confirmation</h5>
                    <button type="button" class="btn-close col-auto me-1" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="d-flex justify-content-center align-items-center mt-4 flex-column">
                    <img src="~/images/caution.png" style="height: 40px; width: 40px;">
                    <span>Are you sure you want to delete this table?</span>
                    <form id="deleteTableForm">
                        <input id="table" type="hidden" />
                        <input id="section" type="hidden" />
                        <div class="d-flex justify-content-center align-items-center mt-2 mb-4">
                            <button type="submit" class="btn btn-primary" data-bs-dismiss="modal"
                                style="border-radius: 3px; width: 60px;">Yes</button>
                            <button type="button" class="btn ms-2 border" data-bs-dismiss="modal"
                                style="border-radius: 3px; width: 60px;">No</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    @* mass delete table modal *@
    <div class="modal " id="massDeleteTable" tabindex="-1" aria-labelledby="massDeleteTableLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-white">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="massDeleteTableLabel">
                        Delete Confirmation
                    </h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body d-flex flex-column ">
                    <img src="/images/toppng.com-warning-icon-2400x2400.png" alt="" width="30px"
                        class="align-self-center">
                    <p class="align-self-center">Are you sure you want to delete all this Table?</p>
                </div>
                <div class="modal-footer d-flex justify-content-center">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal"
                        id="massDeleteTableBtnModel">Yes</button>
                    <button type="button" class="btn btn-pizza2" data-bs-dismiss="modal">
                        No
                    </button>
                </div>
            </div>
        </div>
    </div>

    @* add section modal *@
    <div class="modal" id="addSectionModal" tabindex="-1" aria-labelledby="addSectionLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" style="width: 500px;">
            <div class="modal-content ps-3 pe-3">
                <div class="row mt-2">
                    <h5 class="modal-title col" id="staticBackdropLabel">Add Section</h5>
                    <button type="button" class="btn-close col-auto me-3" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <form class="mt-4" id="addSectionForm">
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="SectionName" name="SectionName" placeholder="Name">
                        <label for="SectionName" class="label-pad">Name</label>
                    </div>
                    <div class="form-floating">
                        <input type="text" class="form-control" id="SectionDescription" name="SectionDescription"
                            placeholder="Description">
                        <label for="SectionDescription" class="label-pad">Description</label>
                    </div>
                    <div class="d-flex justify-content-end align-items-center mt-5 mb-4">
                        <button type="submit" class="btn btn-primary" data-bs-dismiss="modal"
                            style="border-radius: 3px;" id="Save">Save</button>
                        <button type="button" class="btn ms-2 border" data-bs-dismiss="modal"
                            style="border-radius: 3px; ">Cancel</button>
                    </div>
                </form>

            </div>
        </div>
    </div>

    @* edit section modal *@
    <div class="modal" id="editSectionModal" tabindex="-1" aria-labelledby="editSectionLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" style="width: 500px;">
            <div class="modal-content ps-3 pe-3">
                <div class="row mt-2">
                    <h5 class="modal-title col" id="staticBackdropLabel">Edit Section</h5>
                    <button type="button" class="btn-close col-auto me-3" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <form class="mt-4" id="editSectionForm">
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="EditSectionname" name="EditSectionname"
                            placeholder="Name">
                        <label for="EditSectionname" class="label-pad">Name</label>
                    </div>
                    <div class="form-floating">
                        <input type="text" class="form-control" id="EditDescription" name="EditDescription"
                            placeholder="Description">
                        <label for="EditDescription" class="label-pad">Description</label>
                    </div>
                    <input type="hidden" id="Sectionid" />
                    <div class="d-flex justify-content-end align-items-center mt-5 mb-4">
                        <button type="submit" class="btn btn-primary" data-bs-dismiss="modal"
                            style="border-radius: 3px;" id="Save">Save</button>
                        <button type="button" class="btn ms-2 border" data-bs-dismiss="modal"
                            style="border-radius: 3px; ">Cancel</button>
                    </div>
                </form>

            </div>
        </div>
    </div>

    <div id="TableModal" tabindex="-1" aria-labelledby="addTableLabel" aria-hidden="true">

    </div>
</section>
    <script>
        $(document).ready(function () {
            let lastSelectedSectionId = 0;

            $(document).on("click", ".delete-section", function () {
                var Id = $(this).data("id");
                $("#hiddenField").val(Id);
            });

            function sectionList() {
                $.ajax({
                    url: '/Table/Section',
                    type: 'GET',
                    success: function (data) {
                        $('#Sections').html(data);
                    }
                });
            };

            function TableList(sectionId, page) {
                let pageSize = $("#pageSizeSelect").val();
                let search = $("#search").val();
                $.ajax({
                    type: "GET",
                    url: '/Table/Tables',
                    contentType: "application/json",
                    data: { page: page, pageSize: pageSize, search: search, sectionId: sectionId },
                    success: function (data) {
                        $('#TablesBySection').html(data);
                    }
                });
            };

            $("#TablesBySection").on("click", ".pagination-link", function (e) {
                e.preventDefault();
                let page = $(this).data("page");
                let sectionId = $("#sectionId").val();
                if (page > 0) {
                    TableList(sectionId, page);
                }
            });

            $("#TablesBySection").on("change", "#pageSizeSelect", function () {
                let sectionId = $("#sectionId").val();
                TableList(sectionId, 1);
            });

            let searchTimer;
            $("#search").on("input", function () {
                clearTimeout(searchTimer);
                let sectionId = $("#sectionId").val();
                searchTimer = setTimeout(function () {
                    TableList(sectionId || lastSelectedSectionId, 1);
                }, 100);
            });

            $(document).on("click", ".selectedSection", function () {
                var sectionId = $(this).data("id");
                console.log(sectionId + "section");
                lastSelectedSectionId = sectionId;
                TableList(sectionId, 1);
            });

            $("#addSectionForm").submit(function (e) {
                e.preventDefault(); // Prevent page refresh

                var formData = {
                    Sectionname: $("#SectionName").val(),
                    Description: $("#SectionDescription").val()
                };
                console.log(formData);
                $.ajax({
                    type: "POST",
                    url: '/Table/AddSection',
                    contentType: "application/json",
                    data: JSON.stringify(formData),
                    success: function (response) {
                        $("#SectionName").val("");
                        $("#SectionDescription").val("");
                        sectionList();
                    }
                });
            });

            $(document).on("click", ".edit-btn", function () {
                var sectionId = $(this).data("id");
                $.ajax({
                    type: "GET",
                    url: '/Table/EditSectionById',
                    contentType: "application/json",
                    data: { sectionId: sectionId },
                    success: function (data) {
                        console.log(data);
                        $("#Sectionid").val(data.sectionid);
                        $('#EditSectionname').val(data.sectionname);
                        $('#EditDescription').val(data.description);
                    }
                });
            });
            $("#editSectionForm").submit(function (e) {
                e.preventDefault(); // Prevent page refresh

                var formData = {
                    Sectionid: $("#Sectionid").val(),
                    Sectionname: $("#EditSectionname").val(),
                    Description: $("#EditDescription").val()
                };
                console.log(formData);
                $.ajax({
                    type: "POST",
                    url: '/Table/EditSectionById',
                    contentType: "application/json",
                    data: JSON.stringify(formData),
                    success: function (response) {
                        sectionList();
                    }
                });
            });

            $("#deleteSectionForm").submit(function (e) {
                e.preventDefault(); // Prevent page refresh
                var sectionId = $("#hiddenField").val();
                console.log(sectionId + "section");
                $.ajax({
                    type: "POST",
                    url: '/Table/DeleteSection',
                    data: { sectionId: sectionId },
                    success: function (response) {
                        sectionList();
                        TableList(sectionId, 1);
                    }
                });
            });

            $(document).on("click", ".addTable", function () {
                console.log("clicked");
                $.ajax({
                    url: "/Table/AddNewTable",
                    type: "GET",
                    success: function (response) {
                        $("#TableModal").html(response);
                        $("#AddTableModal").modal("show");
                    }
                });
            });

            $(document).on("click", "#SaveTable", function (e) {
                e.preventDefault();
                console.log("clicked");
                var formData = new FormData($("#addTableForm")[0]);
                var sectionId = $("#SectionId").val();
                console.log(formData + "Hii");
                $.ajax({
                    url: "/Table/AddNewTable",
                    type: "POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                    dataType: "json",
                    success: function (response) {
                        TableList(sectionId, 1);
                    },
                    error: function (error) {

                    }
                });
            });

            $(document).on("click", ".deleteTable", function () {
                var table = $(this).data("id");
                console.log(table + "delete");
                var section = $(this).data("sectionid");
                $("#table").val(table);
                $("#section").val(section);
            });

            $("#deleteTableForm").submit(function (e) {
                e.preventDefault(); // Prevent page refresh
                var tableId = $("#table").val();
                var sectionId = $("#section").val();
                console.log(tableId + "delete");
                $.ajax({
                    type: "POST",
                    url: '/Table/DeleteTable',
                    data: { tableId: tableId },
                    success: function (response) {
                        TableList(sectionId, 1);
                    }
                });
            });

            $(document).on("click", ".editTable", function () {
                var tableId = $(this).data("id");
                console.log("clicked");
                $.ajax({
                    url: "/Table/editTable",
                    type: "GET",
                    data: { tableId: tableId },
                    success: function (response) {
                        $("#TableModal").html(response);
                        $("#EditTableModal").modal("show");
                    }
                });
            });

            $(document).on("click", "#SaveEditTable", function (e) {
                e.preventDefault();
                console.log("clicked");
                var formData = new FormData($("#editTableForm")[0]);
                var Sectionid = $("#SectionId").val();
                console.log(Sectionid + "section");
                console.log(formData + "Hii");
                $.ajax({
                    url: "/Table/editTable",
                    type: "POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                    dataType: "json",
                    success: function (response) {
                        TableList(Sectionid, 1);
                    },
                    error: function (error) {

                    }
                });
            });

            sectionList();
        });
    </script>