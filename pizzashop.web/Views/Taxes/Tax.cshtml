@{
    Layout = "_Layout";
    ViewData["Title"] = "Tax Page";
}
@using pizzashop.service.Interfaces
@inject IPermissionService PermissionService
@{
    var permission = await PermissionService.GetCurrentUserPermissionsForModule("TaxAndFee");
}
<head>
    <link rel="stylesheet" href="~/css/Menu.css">
</head>
<section style="min-height: 100vh;background-color: #fafafa;">
    <div class="row pt-4 ms-sm-5 me-sm-5 ms-3 me-3" style="height: 70px;">
        <h2 class="col-sm col-12" style="color: rgb(101, 101, 224); font-family: Roboto; font-weight: 550">Taxes/Fees
        </h2>
        <input type="search" class="col-sm-auto col-6 mb-sm-1 mb-2" id="search" placeholder="search"
            style="border-radius: 3px; border: none; min-height: 50px;">
            @if(permission.Canaddedit == true){
        <button type="button" class="btn btn-prime col-sm-auto col-4 ms-sm-2 ms-auto align-items-center d-flex addTax mb-sm-1 mb-2"
            style="border-radius: 4px; ">
            + New Tax
        </button>
        }
    </div>

    <div class="row table-responsive pt-4 ms-2 me-2 mt-sm-1 mt-4" id="Taxes">

    </div>
    <div id="TaxModal" tabindex="-1" aria-labelledby="addEditTableLabel" aria-hidden="true">

    </div>
    <div class="fade modal" id="DeleteTaxModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" style="width: 400px;">
            <div class="modal-content">
                <div class="row mx-1 mt-2">
                    <h5 class="modal-title col" id="staticBackdropLabel">Delete confirmation</h5>
                    <button type="button" class="btn-close col-auto me-1" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="d-flex justify-content-center align-items-center mt-4 flex-column">
                    <img src="~/images/caution.png" style="height: 40px; width: 40px;">
                    <span>Are you sure you want to delete this tax?</span>
                    <form id="deleteTaxForm">
                        <input id="tax" type="hidden" />
                        <div class="d-flex justify-content-center align-items-center mt-2 mb-4">
                            <button type="submit" class="btn btn-primary" data-bs-dismiss="modal"
                                style="border-radius: 3px; width: 60px;">Yes</button>
                            <button type="button" class="btn ms-2 border" data-bs-dismiss="modal"
                                style="border-radius: 3px; width: 60px;">No</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>
<script>
    $(document).ready(function () {


        function TaxList(page) {
            let pageSize = $("#pageSizeSelect").val();
            let search = $("#search").val();
            $.ajax({
                type: "GET",
                url: '/Taxes/TaxTable',
                contentType: "application/json",
                data: { page: page, pageSize: pageSize, search: search },
                success: function (data) {
                    console.log(data);
                    $('#Taxes').html(data);
                }
            });
        };

        $("#Taxes").on("click", ".pagination-link", function (e) {
            e.preventDefault();
            let page = $(this).data("page");
            if (page > 0) {
                TaxList(page);
            }
        });

        $("#Taxes").on("change", "#pageSizeSelect", function () {
            TaxList(1);
        });

        let searchTimer;
        $("#search").on("input", function () {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(function () {
                TaxList(1);
            }, 100);
        });

        $(document).on("click", ".addTax", function () {
            $.ajax({
                type: "GET",
                url: '/Taxes/GetTaxModal',
                success: function (data) {
                    $('#TaxModal').html(data);
                    $("#AddTaxModal").modal("show");
                },
                error: function (error) {
                    console.error("Error loading tax modal:", error);
                }
            });
        });

        // Load the "Edit Tax" modal
        $(document).on("click", ".editTax", function () {
            let taxId = $(this).data("id");
            $.ajax({
                type: "GET",
                url: '/Taxes/GetTaxModal',
                data: { id: taxId },
                success: function (data) {
                    $('#TaxModal').html(data);
                    $("#AddTaxModal").modal("show");
                },
                error: function (error) {
                    console.error("Error loading tax modal:", error);
                }
            });
        });

        $(document).on("click", "#SaveTax", function (e) {

            if($('#addEditTaxForm').valid()){
            e.preventDefault();

            var formData = new FormData($("#addEditTaxForm")[0]);
            console.log(formData);

            $.ajax({
                type: "POST",
                url: '/Taxes/SaveTax',
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    if (response.success) {
                        TaxList(1);
                        $('#AddTaxModal').modal('hide');
                    }
                    else{
                        $("#Taxname").after('<div class="error-message text-danger mt-1">' + response.message + '</div>');
                    }
                },
                error: function (error) {
                    console.error("Error saving tax:", error);
                }
            });
            }
        });

        $(document).on("click", ".deleteTax", function () {
                var table = $(this).data("id");
                $("#tax").val(table);
            });

        // Handle tax deletion
        $("#deleteTaxForm").submit(function (e) {
            e.preventDefault();
                var taxId = $("#tax").val();
                console.log(taxId + "tax");

                $.ajax({
                    type: "POST",
                    url: '/Taxes/DeleteTax',
                    data: { id: taxId },
                    success: function (response) {
                        if (response.success) {
                            TaxList(1);
                        } 
                    },
                    error: function (error) {
                        console.error("Error deleting tax:", error);
                    }
                });
        });


        TaxList(1);

    });
</script>